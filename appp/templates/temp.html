<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Splash Screen</title>
    <meta name="google-signin-client_id" content="569729035262-k7aqi97afdolj7o3bo2ii1603ivs5nra.apps.googleusercontent.com">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Roboto:wght@400&display=swap" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/splash.css') }}" rel="stylesheet">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/favicon.png') }}">
    <link rel="manifest" href="/static/manifest.json">
    <link href="{{ url_for('static', filename='css/splash.css') }}" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* Style section remains the same */
    </style>
</head>
<body>
    <div class="container">
        <!-- Content structure remains the same -->
    </div>
    <script>
        const isMobileDevice = () => {
            return /Mobi|Android|iPhone|iPad|iPod/.test(navigator.userAgent);
        };

        const isAndroidDevice = () => {
            return /Android/.test(navigator.userAgent);
        };

        const initialize = () => {
            if (!isMobileDevice()) {
                window.location.href = 'https://www.firley.org/products/ecolens-redirect';
            }
        };

        initialize();

        document.addEventListener("DOMContentLoaded", function(event) {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            const setupCompleted = localStorage.getItem('setupCompleted');
            const email = localStorage.getItem('email');

            if (isStandalone) {
                if (!email) {
                    document.getElementById('signInButtonContainer').classList.remove('hidden');
                } else if (!setupCompleted) {
                    runStandaloneSetup();
                } else {
                    setTimeout(() => {
                        window.location.href = '/home';
                    }, 4000);
                }
            } else {
                if (!email) {
                    runSetupProcess();
                } else {
                    runSetupProcess();
                }
            }
        });

        function runSetupProcess() {
            const splashContent = document.getElementById('splashContent');
            const subContent = document.getElementById('subContent');
            const signInButtonContainer = document.getElementById('signInButtonContainer');

            if (signInButtonContainer) {
                signInButtonContainer.classList.add('hidden');
            }

            splashContent.classList.add('fade-in');
            subContent.classList.add('fade-in');
            setTimeout(() => {
                splashContent.classList.remove('fade-in');
                splashContent.classList.add('fade-out');
                subContent.classList.remove('fade-in');
                subContent.classList.add('fade-out');
                document.body.style.backgroundColor = "#fff";
                setTimeout(() => {
                    if (isAndroidDevice()) {
                        showAndroidInstallInstructions(splashContent);
                    } else {
                        showIOSInstallInstructions(splashContent);
                    }
                }, 2000);
            }, 2000);
        }

        function showIOSInstallInstructions(splashContent) {
            splashContent.innerHTML = `
                <div class="main-text">Install <span class="highlight">EcoLens</span></div>
                <div class="sub-text">ðŸ˜Š</div>
                <div class="sub-text left-align">1 - Tap the Share Button</div>
                <div><img class="step-img" src="/static/images/share-ios.png" alt="Step 1"></div>
                <div class="sub-text left-align">2 - Scroll down a bit</div>
                <div class="sub-text left-align">3 - Tap Add to Home Screen</div>
                <div><img class="step-img" src="/static/images/add2hs.jpg" alt="Step 3"></div>
            `;
            splashContent.classList.add('fade-in');
        }

        function showAndroidInstallInstructions(splashContent) {
            splashContent.innerHTML = `
                <div class="main-text">Install <span class="highlight">EcoLens</span></div>
                <div class="sub-text">ðŸ˜Š</div>
                <div class="sub-text left-align">1 - Tap the Menu Button</div>
                <div><img class="step-img" src="/static/images/menu-android.png" alt="Menu Icon"></div>
                <div class="sub-text left-align">2 - Tap 'Add to Home Screen'</div>
                <div><img class="step-img" src="/static/images/add2hs-android.png" alt="Add to Home Screen"></div>
            `;
            splashContent.classList.add('fade-in');
        }

        window.onload = function() {
            google.accounts.id.initialize({
                client_id: '569729035262-k7aqi97afdolj7o3bo2ii1603ivs5nra.apps.googleusercontent.com',
                callback: handleCredentialResponse
            });

            if (!localStorage.getItem('isSignedIn')) {
                google.accounts.id.renderButton(
                    document.getElementById('signInButtonContainer'),
                    { theme: 'outline', size: 'large' }
                );
                google.accounts.id.prompt();
            } else {
                document.getElementById('signInButtonContainer').style.display = 'none';
            }
        };

        function handleCredentialResponse(response) {
            const idToken = response.credential;
            fetch('/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ idToken: idToken })
            }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    localStorage.setItem('email', data.email);
                    localStorage.setItem('profilePic', data.profilePic);
                    localStorage.setItem('isSignedIn', true);
                    if (window.matchMedia('(display-mode: standalone)').matches) {
                        runStandaloneSetup();
                    } else {
                        document.getElementById('signInButtonContainer').style.display = 'none';
                    }
                } else {
                    console.error('Login failed');
                    localStorage.removeItem('isSignedIn');
                }
            });
        }

        function trackVideoCompletion() {
            const player = new YT.Player('youtubeVideo', {
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function checkCheckboxes() {
            const termsChecked = document.getElementById('termsCheckbox').checked;
            const privacyChecked = document.getElementById('privacyCheckbox').checked;

            if (termsChecked && privacyChecked) {
                document.getElementById('videoPage').classList.remove('hidden');
                trackVideoCompletion();
            }
        }

        // Other functions like runStandaloneSetup and onYouTubeIframeAPIReady remain the same
    </script>
</body>
</html>
